{% schema %}
{
  "name": "Carrossel Parallax",
  "max_blocks": 10,
  "settings": [
    {
      "type": "range",
      "id": "section_height",
      "label": "Altura da seção (vh)",
      "min": 60,
      "max": 100,
      "step": 5,
      "default": 90
    }
  ],
  "blocks": [
    {
      "type": "card",
      "name": "Card",
      "settings": [
        {
          "type": "image_picker",
          "id": "bg_image",
          "label": "Imagem de fundo"
        },
        {
          "type": "image_picker",
          "id": "card_image",
          "label": "Imagem do card (camisa PNG)"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Título do card",
          "default": "Camisa Oficial"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link do botão"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Carrossel Parallax",
      "category": "Custom"
    }
  ]
}
{% endschema %}

<section class="coverflow-carousel" style="height: {{ section.settings.section_height }}vh">
  <div class="carousel-bg-wrapper" id="bgWrapper">
    {% for block in section.blocks %}
      {% assign bg = block.settings.bg_image %}
      <div class="carousel-bg" style="background-image: url('{{ bg | image_url: width: 2000 }}')"></div>
    {% endfor %}
  </div>

  <div class="swiper coverflow-swiper">
    <div class="swiper-wrapper">
      {% for block in section.blocks %}
        {% assign img = block.settings.card_image %}
        <div class="swiper-slide card" data-tilt data-tilt-max="10" data-tilt-speed="400">
          <div class="card-glass">
            {% if img %}
              <img src="{{ img | image_url: width: 600 }}" alt="Camisa" class="shirt-img" loading="lazy">
            {% endif %}
            <h2>{{ block.settings.title }}</h2>
            <a href="{{ block.settings.link }}" class="btn-card">Ver Produto</a>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</section>

<style>
.coverflow-carousel {
  position: relative;
  width: 100%;
  overflow: hidden;
  background: #000;
}

.carousel-bg-wrapper {
  position: absolute;
  inset: 0;
  z-index: 0;
  overflow: hidden;
  pointer-events: none;
}

.carousel-bg {
  position: absolute;
  inset: 0;
  background-size: cover;
  background-position: center;
  opacity: 0;
  transition: opacity 0.6s ease;
}
.carousel-bg.active {
  opacity: 1;
  z-index: 1;
}

.swiper {
  position: relative;
  z-index: 2;
  height: 100%;
  display: flex;
  align-items: center;
  padding: 0 10vw; /* margem lateral para ver cards anteriores/próximos */
}

.swiper-slide {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: 1.5rem;
  border: 1px solid rgba(255,255,255,0.15);
  text-align: center;
  padding: 2rem;
  color: white;
  box-shadow: 0 20px 45px rgba(0, 0, 0, 0.4);
  width: 60vw !important; /* menor para mostrar outros cards */
  max-width: 360px;
}

.card-glass {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
}

.shirt-img {
  max-width: 100%;
  height: auto;
  object-fit: contain;
  pointer-events: none;
}

.btn-card {
  background: #8b5cf6;
  color: white;
  padding: 0.7rem 1.4rem;
  border-radius: 999px;
  font-weight: 600;
  text-decoration: none;
  transition: background 0.3s;
}
.btn-card:hover {
  background: #7c3aed;
}
</style>

<!-- SwiperJS + Tilt + GSAP -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.7.2/vanilla-tilt.min.js"></script>
<script src="https://unpkg.com/gsap@3/dist/gsap.min.js"></script>
<script src="https://unpkg.com/gsap@3/dist/ScrollTrigger.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const swiper = new Swiper('.coverflow-swiper', {
      effect: 'coverflow',
      grabCursor: true,
      centeredSlides: true,
      slidesPerView: 'auto',
      loop: false,
      spaceBetween: 32,
      coverflowEffect: {
        rotate: 10,
        stretch: 0,
        depth: 150,
        modifier: 1,
        slideShadows: true,
      }
    });

    const bgs = document.querySelectorAll(".carousel-bg");
    function updateBg(index) {
      bgs.forEach((bg, i) => {
        bg.classList.toggle("active", i === index);
      });
    }

    updateBg(swiper.realIndex);
    swiper.on("slideChange", () => {
      updateBg(swiper.realIndex);
    });

    // Parallax do fundo com GSAP
    const wrapper = document.querySelector('.coverflow-carousel');
    if (window.ScrollTrigger && window.gsap) {
      gsap.to(bgs, {
        yPercent: -20, // mais perceptível
        ease: "none",
        scrollTrigger: {
          trigger: wrapper,
          start: "top bottom",
          end: "bottom top",
          scrub: true
        }
      });
    }
  });
</script>