{% schema %}
{
  "name": "Carrossel Parallax",
  "max_blocks": 10,
  "settings": [
    {
      "type": "text",
      "id": "section_title",
      "label": "Título da seção",
      "default": "Coleção em destaque"
    },
    {
      "type": "range",
      "id": "section_height",
      "label": "Altura da seção (vh)",
      "min": 60,
      "max": 100,
      "step": 5,
      "default": 90
    }
  ],
  "blocks": [
    {
      "type": "card",
      "name": "Card",
      "settings": [
        {
          "type": "image_picker",
          "id": "bg_image",
          "label": "Imagem de fundo"
        },
        {
          "type": "image_picker",
          "id": "card_image",
          "label": "Imagem do card (camisa PNG)"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Título do card",
          "default": "Camisa Oficial"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link do botão"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Carrossel Parallax",
      "category": "Custom"
    }
  ]
}
{% endschema %}

<section class="parallax-carousel" style="height: {{ section.settings.section_height }}vh">
  <div class="carousel-background" id="carouselBg"></div>

  <div class="carousel-wrapper" id="carousel">
    {% for block in section.blocks %}
      {% assign bg = block.settings.bg_image %}
      {% assign img = block.settings.card_image %}
      <div class="card" 
        data-tilt 
        data-tilt-max="10" 
        data-tilt-speed="400" 
        data-tilt-glare="false"
        data-tilt-gyroscope="true"
        data-bg="{{ bg | image_url: width: 1600 }}">
        
        <div class="card-glass">
          {% if img %}
            <img src="{{ img | image_url: width: 600 }}" alt="Camisa" class="shirt-img" loading="lazy">
          {% endif %}
          <h2>{{ block.settings.title }}</h2>
          <a href="{{ block.settings.link }}" class="btn-card">Ver Produto</a>
        </div>
      </div>
    {% endfor %}
  </div>
</section>

<style>
.parallax-carousel {
  position: relative;
  width: 100%;
  overflow: hidden;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.carousel-background {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  transition: background-image 0.7s ease-in-out;
  z-index: 0;
}

.carousel-wrapper {
  position: relative;
  z-index: 2;
  display: flex;
  flex-direction: row;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  gap: 2rem;
  padding: 2rem;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}
.carousel-wrapper::-webkit-scrollbar {
  display: none;
}

.card {
  flex: 0 0 85% !important;
  scroll-snap-align: center;
  background: rgba(255, 255, 255, 0.08) !important;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: 1.5rem !important;
  border: 1px solid rgba(255,255,255,0.15) !important;
  padding: 2rem !important;
  text-align: center;
  color: white;
  box-shadow: 0 20px 45px rgba(0, 0, 0, 0.4) !important;
  transition: transform 0.3s ease !important;
}

.card-glass {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
}

.shirt-img {
  max-width: 100%;
  height: auto;
  object-fit: contain;
  pointer-events: none;
}

.btn-card {
  background: #8b5cf6;
  color: white;
  padding: 0.7rem 1.4rem;
  border-radius: 999px;
  font-weight: 600;
  text-decoration: none;
  transition: background 0.3s;
}
.btn-card:hover {
  background: #7c3aed;
}
</style>

<!-- Tilt.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.7.2/vanilla-tilt.min.js"></script>

<!-- GSAP ScrollTrigger para Parallax -->
<script src="https://unpkg.com/gsap@3/dist/gsap.min.js"></script>
<script src="https://unpkg.com/gsap@3/dist/ScrollTrigger.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const carousel = document.getElementById('carousel');
    const bg = document.getElementById('carouselBg');
    const cards = carousel.querySelectorAll('.card');

    const updateBg = (img) => {
      if (!img) return;
      bg.style.backgroundImage = `url(${img})`;
    }

    const observeScroll = () => {
      let observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const card = entry.target;
            const img = card.dataset.bg;
            updateBg(img);
          }
        });
      }, {
        root: carousel,
        threshold: 0.5
      });

      cards.forEach(card => observer.observe(card));
    }

    observeScroll();

    if (window.ScrollTrigger && window.gsap) {
      gsap.to(bg, {
        y: -150, // Parallax mais visível
        ease: "none",
        scrollTrigger: {
          trigger: carousel,
          start: "top bottom",
          end: "bottom top",
          scrub: true
        }
      });
    }
  });
</script>